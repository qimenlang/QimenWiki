# 资源管理

### 离线资源管理

### 运行时资源管理

1. 运行时资源管理器的主要职责：载入资源至内存，所有职责都与该主要职责有关
   - 确保任何时候，同一个资源在内存只有一份
   - 管理每个资源的**生命周期**，载入需要的资源，在不需要的时候卸载
   - 处理**复合资源**的载入，复合资源由多个资源组成；
   - 维护资源引用完整性
     - 内部引用完整性：单个资源文件内的交叉引用
     - 外部引用完整性：资源间跨文件的交叉引用
     - 载入复合资源时，必须确保子资源也被载入，并正确的修补交叉引用；
   - 管理资源载入后的**内存用量**，确保资源存储在内存中合适的地方；
   - 允许按照资源类型，载入资源后执行自定义的处理，称为资源登录或资源载入初始化；
   - 通常提供单一统一接口管理多种资源类型；
   - 处理串流（异步资源载入）；
2. 资源全局统一标识符(GUID: globally unique identifier)
   - 最常见的GUID是资源的文件系统路径，存储为字符串或其３２位散列码，可以确保唯一性；
   - 对于多个资源存储在一个大文件中的情况，采取文件路径＋资源名的形式，确保唯一性；
3. 资源注册表
   - 使用资源注册表，记录已载入的资源，保证同一个资源在内存中只有一份；
   - 最简单的资源注册表是键值 key-value pair，键值为GUID；载入时，资源以GUID为主键加入资源注册表，卸载时，删除注册表记录；
   - 游戏请求某资源时，资源管理器先用其GUID查找资源注册表，若能找到，直接传回资源指针；否则就载入资源；
   - 若在游戏运行时载入某资源，可能会因IO而导致掉帧卡顿，该情况通常有两种处理方式：
     - 在运行时完全禁止加载资源
     - 在运行时以异步形式加载资源
4. 资源的生命周期
   - 资源的生命期：资源载入内存至该内存被归还给系统
   - 载入并驻留（load-and-stay-resident LSR）：资源在游戏开始时便被载入，并驻留在内存直至游戏结束,例如玩家的角色；
   - 有些资源的生命期对应某一关卡；
   - 有些资源的生命期短于一个关卡，用完即释放：过场动画；
   - 有些资源的边用边释放：背景音之类；
   - 何时释放
5. 处理资源间的交叉引用
   - 交叉引用是如何存储于内存和磁盘中的
     - 在内存中，资源间使用指针或引用来实现相互引用；
     - 交叉引用存储到磁盘时，存储引用资源的GUID；
     - 内存中资源的指针和磁盘中资源的GUID相互转化，通过全局资源查找表；
     - 全局资源查找表，以资源的GUID为主键，资源的指针为value；
   - 处理外部引用
     - 资源对象所属文件的路径＋资源名＝GUID，作为**资源查找表**主键
     - 应该是在文件的**资源交叉引用表**中，存储了其他被引用文件的GUID(资源文件路径＋资源名)；
6. 资源载入后的初始化和卸载
   - 许多类型的资源在载入后，还需要一些整理才能供引擎使用；例如加载了三维模型后，需要定义三维网格的顶点和索引，并传送至显存；
7. 