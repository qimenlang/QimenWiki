# stencil模板缓冲

### 模板缓冲流程

1. 启用模板缓冲写入
2. 渲染物体，更新模板缓冲
3. 禁用模板缓冲写入
4. 根据模板缓冲内容，渲染其他物体

### 传送门效果实现

##### 方案1

1. 同时存在两个场景A、B和一个传送门，传送门一直渲染；
2. 传送门暂时只是一个面片；
3. 渲染传送门面片的片段时，修改对应的模板缓冲为1，非传送门区域为0；穿过传送门后，模板缓冲的0\1设置倒换过来；
4. 模板缓冲为0的区域，渲染A场景，模板缓冲为1的区域，渲染B场景；

##### 方案2 圆球代替传送门，只使用模板测试

1. 使用一个圆球代替传送么门，可以通过圆球看到场景2
2. 场景切换时，圆球扩大
   - 如果相机正对圆球，相机未与圆球碰撞前，一切正常，与圆球碰撞之后，如果场景1的地面更高，会只能看到场景1的地面；
   - 如果相机背对圆球，圆球扩大到包括了相机之后，效果会是突然切换到场景2；
   - 如果相机侧对圆球，圆球扩大过程中，会看到圆弧形状的场景切换的截面，圆球相机碰撞之后，也会有因圆球被遮挡
3. 发生碰撞之后完全切换到场景2，依赖的是事件，而不是模板测试

##### 方案final

1. 小球 material 设置 stencil
2. cullface 双面渲染
3. 小球进行深度测试、不写入
4. 场景1、场景2、小球并列，确定渲染顺序，先渲染小球
5. 场景1的所有物体的片段，片段的模板值为0时通过模板测试；场景2的所有物体的片段，片段的模板值为1时通过；

##### 渲染流程

1. 首先[只]渲染小球，写入模板缓冲
2. 渲染场景1，2，做模板测试
3. changebackground时，出现小球，什么时候播放小球放大的动画？

##### 问题

1. 如何在渲染小球时，写入stencil buffer
2. 应该同时渲染场景A、B ，渲染时，如何拿到stencil buffer并使用
3. 小球扩大到与场景A、B相交时，如何保证小球不被遮挡，还能正常写入stencil buffer; [打开深度测试，关闭深度写入]
4. 确定渲染



